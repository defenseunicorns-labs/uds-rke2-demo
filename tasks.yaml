# Copyright 2025 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

includes:
  - setup: https://raw.githubusercontent.com/defenseunicorns/uds-common/refs/tags/v1.17.1/tasks/setup.yaml

variables:
  - name: ARCH
    default: "${UDS_ARCH}"
  - name: VM_NAME
    default: "rke2"
  - name: LIMA_ARGS
    default: "--memory 20 --cpus 10"

tasks:
  - name: default
    description: "Deploy a UDS RKE2 cluster on a fresh Lima VM (destroys previous VM instance!)"
    actions:
      - task: delete-lima-vm
      - task: create-lima-vm
      - task: install

  - name: install
    description: "Build and deploy UDS Core and its prereqs on an RKE2 cluster"
    actions:
      - task: build
      - task: deploy

  - name: build
    description: "Build uds-rke2-demo bundle"
    actions:
      - description: "Build UDS Core prereqs"
        task: build-prereqs
      - description: "Build bundle"
        cmd: "./uds create --confirm --no-progress"

  - name: build-prereqs
    description: "Build prereqs Zarf package"
    actions:
      - description: "Build package with RKE2 prereqs"
        cmd: "./uds zarf package create -a ${ARCH} --confirm --no-progress --skip-sbom"

  - name: create-lima-vm
    description: "Creates Lima RKE2 VM"
    actions:
      - cmd: |
          if [[ "$(uname)" == "Darwin" ]]; then
            limactl start --name="$VM_NAME" template://experimental/rke2 \
              --vm-type=vz --network=vzNAT -y $LIMA_ARGS
          else
            limactl start --name="$VM_NAME" template://experimental/rke2 \
              --vm-type=qemu -y $LIMA_ARGS
          fi
  - name: deploy
    description: "Deploys rke2-core-demo bundle"
    actions:
      - cmd: |
          export KUBECONFIG=$(limactl list --format 'unix://{{.Dir}}/copied-from-guest/kubeconfig.yaml' -- "$VM_NAME")
          ./uds deploy uds-bundle-uds-rke2-demo-*.tar.zst --confirm

  - name: print-kubeconfig-path
    description: "Prints kubeconfig path for the RKE2 instance (Lima VM only)"
    actions: 
      - cmd: |
          echo  "****** Export the following env var to connect to cluster (Lima VM only!) ****** "
          echo export KUBECONFIG=$(limactl list --format 'unix://{{.Dir}}/copied-from-guest/kubeconfig.yaml' -- "$VM_NAME")
          echo "\n"

  - name: delete-lima-vm
    description: "Deletes Lima VM"
    actions:
      - cmd: |
          if ! vm_status="$(limactl list --format '{{.Status}}' -- "${VM_NAME}" 2>/dev/null)"; then
            echo "VM '${VM_NAME}' does not exist."
            exit 0
          fi

          if [ "${vm_status}" = "Running" ]; then
            echo "Stopping '${VM_NAME}''..."
            limactl stop -- "${VM_NAME}" || true
          fi

          echo "Deleting '${VM_NAME}'..."
          limactl delete -f -- "${VM_NAME}" || limactl delete -- "${VM_NAME}"

  - name: get-gw-ips
    actions:
      - description: Print ingress gateway IPs
        cmd: |
          export KUBECONFIG=$(limactl list --format 'unix://{{.Dir}}/copied-from-guest/kubeconfig.yaml' -- "$VM_NAME")
          echo "*** Admin Gateway IP ***"
          ./uds zarf tools kubectl get svc admin-ingressgateway -n istio-admin-gateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
          echo "\n*** Tenant Gateway IP ***"
          ./uds zarf tools kubectl get svc tenant-ingressgateway -n istio-tenant-gateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
          # repeat for additional gateways (ie. passthrough)

  - name: deploy-podinfo
    actions:
      - description: Build and deploy podinfo as an example mission app
        dir: podinfo
        cmd: |
          ./uds zarf package create --confirm
          ./uds zarf package deploy zarf-package-podinfo-*.tar.zst --confirm

  - name: clean
    actions:
      - description: Remove artifacts
        cmd: |
          rm *.tar.zst
